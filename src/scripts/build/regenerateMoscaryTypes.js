/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

import "dotenv-flow/config";
import { exec } from "node:child_process";
import { writeFile } from "node:fs/promises";
import openapiTS, { astToString } from "openapi-typescript";
import { format, resolveConfig } from "prettier";

const targetFilePath = "src/app/functions/server/moscary_schema.d.ts";
const ast = await openapiTS(
  new URL("/api/v1/spec", process.env.MOSCARY_API_BASE),
);
const prettierConfig = await resolveConfig(targetFilePath);
const contents = await format(astToString(ast), {
  filepath: targetFilePath,
  ...prettierConfig,
});
const header = `\
/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

/**
 * This file was auto-generated by \`npm run build-moscary-types\`.
 * Do not make direct changes to the file.
 */

`;
await writeFile(targetFilePath, header + contents);
exec(`npx next lint --fix --file \"${targetFilePath}\"`);
